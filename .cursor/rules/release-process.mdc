---
alwaysApply: false
---

# Release and Changeset Process

## Overview

This project uses **[Changesets](https://github.com/changesets/changesets)** for version management and publishing in a monorepo with two packages:

- `@signalis/core`
- `@signalis/react`

## When to Create a Changeset

Create a changeset for any changes that will be released to users:

- ✅ New features
- ✅ Bug fixes
- ✅ Breaking changes
- ✅ Documentation updates that affect API usage
- ❌ Internal refactoring with no user-facing changes
- ❌ Test-only changes
- ❌ Build/tooling changes

## Creating a Changeset

### Option 1: Interactive (Recommended for Humans)

```bash
pnpm changeset
```

This will prompt you to:

1. Select which packages changed
2. Choose change type (major, minor, or patch)
3. Write a description

### Option 2: Non-Interactive (Recommended for AI)

Create a markdown file directly in `.changeset/` with YAML frontmatter:

```bash
# Create .changeset/descriptive-name.md
---
'@signalis/react': minor
'@signalis/core': patch
---

Brief summary of changes

- Detailed change 1
- Detailed change 2
- Detailed change 3
```

**File naming**: Use kebab-case, descriptive names (e.g., `mixed-deps-usesignaleffect.md`)

## Semantic Versioning Guidelines

### Major (Breaking Changes)

- Removing or renaming public APIs
- Changing function signatures in non-backward-compatible ways
- Removing support for a feature

Example: `'@signalis/core': major`

### Minor (New Features)

- Adding new functions, hooks, or features
- Adding optional parameters to existing APIs
- Deprecating (but not removing) APIs

Example: `'@signalis/react': minor`

### Patch (Bug Fixes)

- Fixing bugs without changing public APIs
- Performance improvements
- Documentation fixes

Example: `'@signalis/core': patch`

## Commit Message Format

Use conventional commit format:

```bash
git commit -m "type(scope): subject

- Detailed bullet point 1
- Detailed bullet point 2"
```

**Types:**

- `feat`: New feature
- `fix`: Bug fix
- `docs`: Documentation only
- `refactor`: Code change without feature/fix
- `test`: Adding or updating tests
- `chore`: Tooling, dependencies, config

**Scopes:**

- `core`: Changes to @signalis/core
- `react`: Changes to @signalis/react
- `root`: Changes to root config/tooling

**Examples:**

```bash
# New feature
git commit -m "feat(react): add deps parameter to useSignalEffect

- Add optional deps parameter for mixed dependencies
- Fix stale closure issue with props/state
- Add comprehensive tests
- Update README with examples"

# Bug fix
git commit -m "fix(core): prevent memory leak in effect cleanup

- Properly dispose observers when effect is removed
- Add test for cleanup behavior"

# Breaking change
git commit -m "feat(core)!: change Signal constructor API

BREAKING CHANGE: Signal constructor now requires explicit type parameter

- Remove type inference from constructor
- Update all internal usages
- Update documentation"
```

## Pull Request Workflow

### 1. Create Feature Branch

```bash
git checkout -b username/feature-description
```

### 2. Make Changes & Create Changeset

```bash
# Make your changes
# ...

# Create changeset (if user-facing changes)
# Create .changeset/descriptive-name.md manually

# Stage and commit
git add .
git commit -m "feat(scope): description"
```

### 3. Push & Create PR

```bash
git push origin username/feature-description

# If using gh CLI
gh pr create --title "feat(scope): description" --body "Description of changes"
```

### 4. PR Requirements

Before merging:

- ✅ All tests pass (`pnpm test`)
- ✅ Linting passes (`pnpm lint`)
- ✅ Build succeeds (`pnpm build`)
- ✅ Changeset created (for user-facing changes)
- ✅ Documentation updated (if needed)

## Publishing a Release

### Automated Release Process (Recommended)

This project uses **[Release It](https://github.com/release-it/release-it)** orchestration with **[Changesets](https://github.com/changesets/changesets)** for version management:

```bash
pnpm release
```

This single command will:

1. **Apply changesets** - Run `pnpm changeset version` to bump workspace package versions
2. **Commit version changes** - Automatically commit the version bump with "chore: version packages"
3. **Install dependencies** - Run `pnpm install` to update lockfile
4. **Build packages** - Run `pnpm build` to compile TypeScript
5. **Create git tag** - Tag based on workspace package version (e.g., `v0.2.7`)
6. **Push to remote** - Push commits and tags to GitHub
7. **Publish to npm** - Publish all workspace packages with `--access public`

**Important**: The root `package.json` version is **not used** for releases. Tags and versions are derived from the workspace packages (`packages/*/package.json`).

### Testing Releases

⚠️ **Warning**: Do NOT use `pnpm release:dry` as it will consume changesets without publishing.

Instead, manually verify:

```bash
# Check what changesets exist
ls .changeset/*.md

# Preview what versions would be bumped
pnpm changeset status

# Verify build works
pnpm build

# Check tests pass
pnpm test
```

### Legacy Manual Process

If needed, the old manual process is still available:

```bash
# Step 1: Version bump
pnpm version

# Step 2: Build packages  
pnpm build

# Step 3: Publish to npm
pnpm release:legacy

# Step 4: Create and push tag manually
git tag v$(node -p 'require("./packages/react/package.json").version')
git push origin --tags
```

## Release It Configuration

See [.release-it.json](mdc:.release-it.json) for current configuration:

- **Git operations disabled** - `release-it` doesn't manage git directly; changesets + hooks do
- **No version bumping** - Version management is delegated to changesets
- **Hooks integration** - Runs changesets, commit, build, tag, push, and publish in sequence
- **Monorepo support** - Works with pnpm workspaces
- **Tag from workspace** - Git tags are created from `packages/react/package.json` version, not root

### Key Configuration Details

```json
{
  "git": {
    "requireCleanWorkingDir": false,
    "commit": false,
    "tag": false,
    "push": false
  },
  "npm": {
    "publish": false
  },
  "hooks": {
    "before:init": [
      "pnpm changeset version",
      "git add .",
      "git commit -m 'chore: version packages' || true",
      "pnpm install",
      "pnpm build"
    ],
    "after:release": [
      "git tag v$(node -p \"require('./packages/react/package.json').version\")",
      "git push --follow-tags",
      "pnpm -r publish --access public"
    ]
  }
}
```

This configuration ensures:
1. **Changesets controls all versioning** - No version drift between root and workspace packages
2. **Automatic commit of version bumps** - The version change is committed before tagging
3. **Tag from workspace package** - Tags reflect actual published version
4. **Single source of truth** - Workspace packages define the version, root package.json is ignored

## Changeset Configuration

See [.changeset/config.json](mdc:.changeset/config.json) for current configuration:

- `commit: false` - Changesets don't auto-commit
- `access: "public"` - Packages are published publicly
- `baseBranch: "main"` - Main branch for versioning
- `updateInternalDependencies: "patch"` - Dependent packages get patch bump

## Examples from This Project

### Recent Changeset Example

```markdown
---
'@signalis/react': minor
---

Add optional deps parameter to useSignalEffect to support mixed dependencies

useSignalEffect now accepts an optional `deps` parameter to handle effects that depend on both signals and non-signal values (props, useState, useContext). When deps change, the effect recreates with fresh closures while signal reactivity continues to work automatically.

- Added `deps?: DependencyList` parameter to `useSignalEffect`
- Updated documentation with examples of mixed dependencies
- Added comprehensive tests for mixed dependency scenarios
- Fixed stale closure issue when effects reference props or state alongside signals
```

### Corresponding Commit

```
feat(react): add deps parameter to useSignalEffect for mixed dependencies

- Add optional deps parameter to useSignalEffect to support mixed dependencies (signals + props/state/context)
- Fix stale closure issue when effects reference props or state alongside signals
- Add comprehensive tests for mixed dependency scenarios
- Update README with examples and best practices for mixed dependencies
```

## Troubleshooting

### Version Drift Between Root and Workspace Packages

**Problem**: Root `package.json` shows different version than workspace packages.

**Solution**: The root `package.json` version is **ignored** in our release process. Only workspace package versions (`packages/*/package.json`) matter.

To verify versions:
```bash
# Check workspace package versions (source of truth)
cat packages/react/package.json | grep version
cat packages/core/package.json | grep version

# Check what's published on npm
npm view @signalis/react version
npm view @signalis/core version
```

### Changesets Consumed Without Publishing

**Problem**: Ran `pnpm release:dry` or release failed, but changesets are gone.

**Why**: `pnpm changeset version` consumes changesets and updates CHANGELOGs immediately, even in dry runs.

**Solution**: The changeset content is now in the CHANGELOG. Either:
1. Manually publish if the code is ready
2. Create a new changeset if you need to make more changes

### Failed Release with Git Tag Created

**Problem**: Release failed but git tag `vX.Y.Z` was created.

**Solution**: Delete the tag locally and remotely:
```bash
# Delete local tag
git tag -d vX.Y.Z

# Delete remote tag
git push origin :refs/tags/vX.Y.Z
```

### How to Verify Fix is Published

After making a fix:
1. Check the CHANGELOG in the workspace package (e.g., `packages/react/CHANGELOG.md`)
2. Note the version number that contains your fix
3. Check npm: `npm view @signalis/react version`
4. If versions match, your fix is live!

### Clean Slate After Failed Release

If the release process created a mess:
```bash
# 1. Check current state
git log --oneline -5
git tag -l "v0.2.*"

# 2. Delete problematic tags
git tag -d vX.Y.Z
git push origin :refs/tags/vX.Y.Z

# 3. If needed, revert bogus commits
git revert <commit-hash>
git push origin main

# 4. Verify clean state
git status
cat packages/react/package.json | grep version
npm view @signalis/react version
```
